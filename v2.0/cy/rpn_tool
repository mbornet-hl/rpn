#!/bin/bash
#
#	rpn_tool : do various operations related to rpn
#	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
#	@(#)	[MB] eo_rpn_tool	Version 1.3 du 21/10/22 - 
#

# _hl {{{
_hl()
{
	hl "$@"
}
# _hl }}}
# usage {{{
usage()
{
	# Is the "hl_tool" config available ?
	# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	hl -op hl_tool | grep -q '\<hl_tool\>'
	if [ $? = 0 ]; then
		# Yes : colorize the usage output
		# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		FILTER='hl --hl_tool'
	else
		# No : don't colorize
		# ~~~~~~~~~~~~~~~~~~~
		FILTER='cat'
	fi

	cat <<- EOF | $FILTER
		Usage: $PROGNAME [-h|-C|-c|-M] [args]
		Version 1.3

		  -h : help (this message)

		  -C : display the catalog of operators for all modules
		       $(usage_catalog_all)

		  -c : display the catalog of operators for the specified module
		       $(usage_catalog)

		  -M : list available modules
		       $(usage_list_modules)

	EOF
}
# usage }}}
# usage_catalog_all {{{

usage_catalog_all()
{
	cat <<- EOF
		Usage: $PROGNAME -C
	EOF
}

# usage_catalog_all }}}
# usage_catalog {{{

usage_catalog()
{
	cat <<- EOF
		Usage: $PROGNAME -c rpn_module
	EOF
}

# usage_catalog }}}
# usage_list_modules {{{

usage_list_modules()
{
	cat <<- EOF
		Usage: $PROGNAME -M
	EOF
}

# usage_list_modules }}}
# catalog_all {{{

catalog_all()
{
	if [ "$1" != '' ]; then
		usage_catalog_all
		exit 1
	fi

	(
		/bin/ls ../rpn_modules/lib*.so | sed 's:.*/lib\(.*\)\.so$:import \1:'
		echo 'catalog'
	) |  "$RPN" -n | _hl --rpn.catalog | less -RX
}

# catalog_all }}}
# catalog {{{
catalog()
{
	if [ "$1" = '' ]; then
		usage_catalog
		exit 1
	fi

	module="$1"
	echo "import $module catalog" | "$RPN" -n | _hl --rpn.catalog | less -RX
}
# catalog }}}
# list_modules {{{
list_modules()
{
	if [ "$1" != '' ]; then
		usage_list_modules
		exit 1
	fi

#	/bin/ls "$RPN_LIBPATH"/*.so | sed 's/.*lib\(.*\)\.so/\1/'
	rpn -sn <<- EOF
		`/bin/ls "$RPN_LIBPATH"/*.so | sed 's/.*lib\(.*\)\.so/import \1/'`
		modules
	EOF
}
# list_modules }}}
# MAIN PROGRAM {{{

PROGNAME="$(basename "$0")"
RPN='./rpn'

if [ "$1" = '' ]; then
	usage
	exit 1
fi
module="$1"

while getopts 'hcCM' opt
do
	case "$opt" in
		C)		shift
				catalog_all "$@"
				exit
				;;

		c)		shift
				catalog "$@"
				exit
				;;

		M)		shift
				list_modules "$@"
				exit
				;;

		h|*)		usage
				exit 1
				;;
	esac
done

usage
exit 1

# MAIN PROGRAM }}}
